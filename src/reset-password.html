<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set New Password | DU Qarze Hasana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0F766E',
                        secondary: '#0D9488',
                        dark: '#0F172A',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-slate-50 text-slate-800 antialiased min-h-screen flex flex-col">

    <!-- Navigation -->
    <nav class="fixed w-full z-50 transition-all duration-300 glass" id="navbar">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <div class="flex-shrink-0 flex items-center gap-2 cursor-pointer"
                    onclick="window.location.href='index.html'">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary to-secondary rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg">
                        Q
                    </div>
                    <span class="font-bold text-xl tracking-tight text-slate-900">DU Qarze Hasana</span>
                </div>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="index.html" class="text-slate-600 hover:text-primary font-medium transition">Home</a>
                    <a href="index.html#how-it-works" class="text-slate-600 hover:text-primary font-medium transition">How it Works</a>
                    <a href="index.html#about" class="text-slate-600 hover:text-primary font-medium transition">About Us</a>
                    <a href="login.html" class="text-slate-600 hover:text-primary font-medium transition">Login</a>
                    <a href="register.html" class="bg-primary hover:bg-secondary text-white px-5 py-2.5 rounded-full font-medium transition shadow-lg">
                        Get Started
                    </a>
                </div>
                <!-- Mobile menu button -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-btn" class="text-slate-600 hover:text-primary focus:outline-none p-2" onclick="toggleMobileMenu()" aria-label="Toggle menu" aria-expanded="false">
                        <i data-lucide="menu" class="w-6 h-6" id="menu-icon"></i>
                        <i data-lucide="x" class="w-6 h-6 hidden" id="close-icon"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-slate-100 shadow-lg">
            <div class="px-4 py-4 space-y-3">
                <a href="index.html" class="block text-slate-600 hover:text-primary font-medium py-2 px-3 rounded-lg hover:bg-slate-50 transition">Home</a>
                <a href="index.html#how-it-works" class="block text-slate-600 hover:text-primary font-medium py-2 px-3 rounded-lg hover:bg-slate-50 transition">How it Works</a>
                <a href="index.html#about" class="block text-slate-600 hover:text-primary font-medium py-2 px-3 rounded-lg hover:bg-slate-50 transition">About Us</a>
                <div class="border-t border-slate-100 pt-3 mt-3">
                    <a href="login.html" class="block text-slate-600 hover:text-primary font-medium py-2 px-3 rounded-lg hover:bg-slate-50 transition">Login</a>
                    <a href="register.html" class="block bg-primary hover:bg-secondary text-white text-center py-3 px-4 rounded-full font-medium transition mt-2">
                        Get Started
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Reset Password Form -->
    <section class="flex-1 flex items-center justify-center pt-28 pb-12 px-4">
        <div class="w-full max-w-md">
            <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 border border-slate-100">
                <div class="text-center mb-8">
                    <div class="w-14 h-14 bg-gradient-to-br from-primary/10 to-secondary/10 rounded-2xl flex items-center justify-center text-primary mx-auto mb-4">
                        <i data-lucide="lock-keyhole" class="w-7 h-7"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-slate-900 mb-2">Set New Password</h1>
                    <p class="text-slate-500">Create a strong password for your account</p>
                </div>

                <!-- Email Display -->
                <div id="emailDisplay" class="hidden mb-6 p-4 rounded-xl bg-slate-50 border border-slate-200">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="user" class="w-5 h-5 text-primary"></i>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">Resetting password for</p>
                            <p class="text-sm font-semibold text-slate-800" id="displayEmail"></p>
                        </div>
                    </div>
                </div>

                <form id="resetForm" class="space-y-5" novalidate>
                    <!-- Error/Success Message -->
                    <div id="messageBox" class="hidden bg-red-50 border border-red-200 text-red-600 p-3 rounded-xl text-sm flex items-center gap-2">
                        <i data-lucide="alert-circle" class="w-5 h-5 flex-shrink-0"></i>
                        <span id="messageText"></span>
                    </div>

                    <!-- New Password -->
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-slate-700 mb-1">
                            New Password <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <i data-lucide="lock" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                            <input type="password" id="newPassword" name="newPassword" required minlength="6"
                                class="w-full pl-10 pr-12 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition"
                                placeholder="Enter new password"
                                autocomplete="new-password">
                            <button type="button" onclick="togglePassword('newPassword', 'toggleNewIcon')" 
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 focus:outline-none p-1"
                                aria-label="Toggle password visibility">
                                <i data-lucide="eye" class="w-5 h-5" id="toggleNewIcon"></i>
                            </button>
                        </div>
                        <p class="text-xs text-slate-400 mt-1">Must be at least 6 characters</p>
                        <p class="text-red-500 text-sm mt-1 hidden flex items-center gap-1" id="newPasswordError">
                            <i data-lucide="alert-circle" class="w-4 h-4"></i>
                            <span id="newPasswordErrorText">Password too short</span>
                        </p>
                    </div>

                    <!-- Confirm Password -->
                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium text-slate-700 mb-1">
                            Confirm Password <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <i data-lucide="lock" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                            <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6"
                                class="w-full pl-10 pr-12 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition"
                                placeholder="Confirm new password"
                                autocomplete="new-password">
                            <button type="button" onclick="togglePassword('confirmPassword', 'toggleConfirmIcon')" 
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 focus:outline-none p-1"
                                aria-label="Toggle password visibility">
                                <i data-lucide="eye" class="w-5 h-5" id="toggleConfirmIcon"></i>
                            </button>
                        </div>
                        <!-- Password Match Indicator -->
                        <div id="matchIndicator" class="hidden mt-2 flex items-center gap-2 text-sm">
                            <i data-lucide="check-circle" class="w-4 h-4" id="matchIcon"></i>
                            <span id="matchText">Passwords match</span>
                        </div>
                        <p class="text-red-500 text-sm mt-1 hidden flex items-center gap-1" id="confirmPasswordError">
                            <i data-lucide="alert-circle" class="w-4 h-4"></i>
                            <span id="confirmPasswordErrorText">Passwords do not match</span>
                        </p>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="submitBtn"
                        class="w-full bg-primary hover:bg-secondary text-white py-3.5 rounded-xl font-semibold transition shadow-lg hover:shadow-xl flex items-center justify-center gap-2 disabled:opacity-60 disabled:cursor-not-allowed">
                        <span id="btnText">Reset Password</span>
                        <svg class="animate-spin h-5 w-5 text-white hidden" id="btnLoader" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <i data-lucide="check" class="w-5 h-5" id="btnIcon"></i>
                    </button>
                </form>

                <div class="mt-8 text-center">
                    <a href="login.html" class="text-slate-600 hover:text-primary font-medium inline-flex items-center gap-2 transition">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i>
                        Back to Login
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 left-4 sm:left-auto transform translate-y-full opacity-0 transition-all duration-300 z-50" role="alert" aria-live="polite">
        <div class="bg-white rounded-xl shadow-2xl border border-slate-200 p-4 flex items-center gap-3 max-w-sm mx-auto sm:mx-0">
            <div id="toastIcon" class="w-10 h-10 rounded-full flex items-center justify-center bg-green-100 text-green-600">
                <i data-lucide="check-circle" class="w-6 h-6"></i>
            </div>
            <div>
                <p id="toastTitle" class="font-semibold text-slate-900">Success</p>
                <p id="toastMessage" class="text-sm text-slate-500">Operation completed</p>
            </div>
        </div>
    </div>

    <script src="assets/js/data.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        lucide.createIcons();

        // =============== MOBILE MENU ===============
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            const menuIcon = document.getElementById('menu-icon');
            const closeIcon = document.getElementById('close-icon');
            const menuBtn = document.getElementById('mobile-menu-btn');
            
            mobileMenu.classList.toggle('hidden');
            menuIcon.classList.toggle('hidden');
            closeIcon.classList.toggle('hidden');
            
            const isExpanded = !mobileMenu.classList.contains('hidden');
            menuBtn.setAttribute('aria-expanded', isExpanded);
        }

        // =============== CHECK SESSION ===============
        const userId = sessionStorage.getItem('duqh_reset_user_id');
        const email = sessionStorage.getItem('duqh_reset_email');

        if (!userId) {
            window.location.href = 'login.html';
        }

        // Display email if available
        if (email) {
            document.getElementById('displayEmail').textContent = email;
            document.getElementById('emailDisplay').classList.remove('hidden');
        }

        // =============== PASSWORD TOGGLE ===============
        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.setAttribute('data-lucide', 'eye-off');
            } else {
                input.type = 'password';
                icon.setAttribute('data-lucide', 'eye');
            }
            lucide.createIcons();
        }

        // =============== REAL-TIME VALIDATION ===============
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const matchIndicator = document.getElementById('matchIndicator');
        const matchIcon = document.getElementById('matchIcon');
        const matchText = document.getElementById('matchText');

        function checkPasswordMatch() {
            const newPass = newPasswordInput.value;
            const confirmPass = confirmPasswordInput.value;

            if (confirmPass.length === 0) {
                matchIndicator.classList.add('hidden');
                return;
            }

            matchIndicator.classList.remove('hidden');

            if (newPass === confirmPass && newPass.length >= 6) {
                matchIndicator.className = 'mt-2 flex items-center gap-2 text-sm text-green-600';
                matchIcon.setAttribute('data-lucide', 'check-circle');
                matchText.textContent = 'Passwords match';
                confirmPasswordInput.classList.remove('border-red-500');
                confirmPasswordInput.classList.add('border-green-500');
            } else if (newPass !== confirmPass) {
                matchIndicator.className = 'mt-2 flex items-center gap-2 text-sm text-red-500';
                matchIcon.setAttribute('data-lucide', 'x-circle');
                matchText.textContent = 'Passwords do not match';
                confirmPasswordInput.classList.remove('border-green-500');
                confirmPasswordInput.classList.add('border-red-500');
            }
            lucide.createIcons();
        }

        newPasswordInput.addEventListener('input', function() {
            if (this.value.length >= 6) {
                this.classList.remove('border-red-500');
                this.classList.add('border-green-500');
                document.getElementById('newPasswordError').classList.add('hidden');
            } else if (this.value.length > 0) {
                this.classList.remove('border-green-500');
                this.classList.add('border-red-500');
            }
            checkPasswordMatch();
        });

        confirmPasswordInput.addEventListener('input', checkPasswordMatch);

        // =============== TOAST NOTIFICATION ===============
        function showToast(type, title, message) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');

            toastTitle.textContent = title;
            toastMessage.textContent = message;

            if (type === 'success') {
                toastIcon.className = 'w-10 h-10 rounded-full flex items-center justify-center bg-green-100 text-green-600';
                toastIcon.innerHTML = '<i data-lucide="check-circle" class="w-6 h-6"></i>';
            } else if (type === 'error') {
                toastIcon.className = 'w-10 h-10 rounded-full flex items-center justify-center bg-red-100 text-red-600';
                toastIcon.innerHTML = '<i data-lucide="x-circle" class="w-6 h-6"></i>';
            }
            lucide.createIcons();

            toast.classList.remove('translate-y-full', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');

            setTimeout(() => {
                toast.classList.add('translate-y-full', 'opacity-0');
                toast.classList.remove('translate-y-0', 'opacity-100');
            }, 4000);
        }

        // =============== MESSAGE BOX ===============
        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            
            messageText.textContent = message;
            if (isError) {
                messageBox.className = 'bg-red-50 border border-red-200 text-red-600 p-3 rounded-xl text-sm flex items-center gap-2';
                messageBox.querySelector('i').setAttribute('data-lucide', 'alert-circle');
            } else {
                messageBox.className = 'bg-green-50 border border-green-200 text-green-600 p-3 rounded-xl text-sm flex items-center gap-2';
                messageBox.querySelector('i').setAttribute('data-lucide', 'check-circle');
            }
            messageBox.classList.remove('hidden');
            lucide.createIcons();
        }

        // =============== FORM SUBMISSION ===============
        document.getElementById('resetForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnLoader = document.getElementById('btnLoader');
            const btnIcon = document.getElementById('btnIcon');

            // Validation
            if (newPassword.length < 6) {
                document.getElementById('newPasswordError').classList.remove('hidden');
                newPasswordInput.classList.add('border-red-500');
                showToast('error', 'Invalid Password', 'Password must be at least 6 characters');
                return;
            }

            if (newPassword !== confirmPassword) {
                document.getElementById('confirmPasswordError').classList.remove('hidden');
                confirmPasswordInput.classList.add('border-red-500');
                showToast('error', 'Mismatch', 'Passwords do not match');
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            btnText.textContent = 'Resetting...';
            btnLoader.classList.remove('hidden');
            btnIcon.classList.add('hidden');

            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 1200));

            // Reset password
            const result = auth.resetPassword(userId, newPassword);

            if (result.success) {
                // Update button to success state
                btnText.textContent = 'Password Reset!';
                btnLoader.classList.add('hidden');
                btnIcon.classList.remove('hidden');
                submitBtn.classList.remove('bg-primary', 'hover:bg-secondary');
                submitBtn.classList.add('bg-green-500');

                showToast('success', 'Password Reset!', 'Redirecting to login...');
                showMessage('Password has been reset successfully!', false);

                // Clear session storage
                sessionStorage.removeItem('duqh_reset_user_id');
                sessionStorage.removeItem('duqh_reset_email');

                // Redirect to login
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            } else {
                // Reset button
                submitBtn.disabled = false;
                btnText.textContent = 'Reset Password';
                btnLoader.classList.add('hidden');
                btnIcon.classList.remove('hidden');

                showToast('error', 'Error', result.message);
                showMessage(result.message, true);
            }
        });
    </script>
</body>

</html>